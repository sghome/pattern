<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis de Patrones de Chladni desde MIDI</title>
    <!-- Incluir la biblioteca P5.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <!-- Incluir la biblioteca Tone.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.26/Tone.js"></script>
</head>
<body style="background-color: black;">
    <h1 style="color: white;">Análisis de Patrones de Chladni desde MIDI</h1>
    <!-- Crear un botón para cargar y analizar el archivo MIDI -->
    <button onclick="startAnalysis()">Cargar y Analizar MIDI</button>
    <!-- Crear un lienzo donde se dibujarán los patrones -->
    <div id="canvas-container" style="float: left;"></div>
    <!-- Mostrar la frecuencia y el nombre de la nota -->
    <div id="info" style="float: right; color: white; margin-right: 50px;"></div>

    <script>
        // Variables globales para el lienzo y las frecuencias
        let canvas;
        let frequencies;

        // Arreglo de colores para los patrones Chladni
        let colors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF'];

        // Función para cargar y analizar el archivo MIDI después de una interacción del usuario
        function startAnalysis() {
            // Iniciar el contexto de audio después de la interacción del usuario
            Tone.start();

            // Cargar y analizar el archivo MIDI después de un corto retraso para asegurarse de que el contexto de audio se inicie
            setTimeout(loadAndAnalyzeMIDI, 100);
        }

        // Función para cargar y analizar el archivo MIDI
        function loadAndAnalyzeMIDI() {
            // Crear un reproductor MIDI
            let player = new Tone.Player("ruta_de_tu_archivo_midi.mid").toDestination();

            // Ajustar la frecuencia de reproducción a 432 Hz
            player.playbackRate = 432 / 440;

            // Obtener las notas y frecuencias del archivo MIDI
            player.get("midi").then(function(midi) {
                frequencies = midi.notes.map(note => Tone.Frequency(note.name).toFrequency());
            });

            // Crear un lienzo P5.js
            canvas = createCanvas(800, 600);
            // Adjuntar el lienzo al contenedor
            canvas.parent('canvas-container');

            // Generar y visualizar los patrones de Chladni en cada fotograma
            drawChladniPatterns();
        }

        // Función para generar y visualizar los patrones de Chladni en cada fotograma
        function drawChladniPatterns() {
            // Limpiar el lienzo en cada fotograma
            clear();

            // Lógica para generar y visualizar los patrones de Chladni
            let numNotes = frequencies.length;
            let margin = 20;
            let startX = margin;
            let endX = width - margin;
            let startY = margin;
            let endY = height - margin;
            let stepX = (endX - startX) / (numNotes - 1);

            // Dibujar círculos según las frecuencias, asignando colores diferentes
            for (let i = 0; i < numNotes; i++) {
                let x = startX + i * stepX;
                let y = map(frequencies[i], 0, 2000, endY, startY); // Ajusta los valores máximos y mínimos según tus necesidades
                let colorIndex = i % colors.length; // Obtener un índice de color dentro del rango de colores disponibles
                fill(colors[colorIndex]); // Establecer el color de relleno
                ellipse(x, y, 10, 10); // Dibujar un círculo en la posición calculada
                // Mostrar la frecuencia y el nombre de la nota asociada
                let freqText = frequencies[i].toFixed(2) + " Hz";
                let noteText = Tone.Frequency(frequencies[i], "midi").toNote();
                let infoText = freqText + " (" + noteText + ")";
                document.getElementById("info").innerHTML += infoText + "<br>";
            }
            
            // Solicitar el próximo fotograma de animación
            requestAnimationFrame(drawChladniPatterns);
        }
    </script>
</body>
</html>
